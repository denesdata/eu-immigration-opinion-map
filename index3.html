<!DOCTYPE html>
<html style="height: 100%">

<head>
    <meta charset="utf-8">
    <style>
        div {
            position: fixed;
            top: 0;
            left: 0;
        }
    </style>
</head>

<body style="height: 100%; margin: 0">
    <div id="chart" style="height: 100%; width: 100%;"></div>
    <script type="text/javascript" src="echarts.min.js"></script>
    <script src="d3-fetch.v1.min.js"></script>
    <script src="d3-dsv.v1.min.js"></script>
    <script src="d3-selection.v1.min.js"></script>
    <script type="text/javascript">

        function percentageFormatter(d) {
            return +d.replace('%', '')
        }

        function getKeyValues(data, index, key, valueArray) {
            var dummy = [];
            for (i = 0; i < data.length; i++) {
                if (data[i][index] == key) {
                    var keys = Object.keys(data[i]);
                    for (j = 0; j < keys.length; j++) {
                        if (valueArray.includes(keys[j])) {
                            dummy.push({
                                'name': keys[j],
                                'value': data[i][keys[j]]
                            })
                        }
                    }
                }
            }
            return dummy
        }

        function getCountryValues(data, index, key) {
            var dummy = [];
            for (i = 0; i < data.length; i++) {
                dummy.push({
                    'name': data[i][index],
                    'value': data[i][key]
                })
            }
            return dummy
        }

        function getMax(data, key) {
            return Math.max.apply(Math, data.map(function (o) { return o[key]; }))
        }

        var categories = ['Securitization', 'Humanitarianism', 'Economy', 'Demographics', 'Identity & Customs'];
        var selected_category = 'Securitization';
        var selected_country = 'Hungary';
        var dimensions = ['Refugee percent', 'Conversation size'];
        var labels = ['EU politics', 'Domestic politics', 'Local note', 'Description'];
        var index = 'Country name';
        var all_dimensions = categories.concat(dimensions).concat(labels);
        var index_all_dimensions = [index].concat(categories).concat(dimensions).concat(labels);
        var countries = []

        d3.json("eu.mini.high.geo.json").then(function (eu) {
            d3.dsv(",", "data.csv", function (d) {
                //remvoe % sign, change labels if needed
                for (i = 0; i < all_dimensions.length; i++) {
                    var dim = all_dimensions[i];
                    d[dim] = percentageFormatter(d[dim])
                }

                //manual overwrites
                //d['Conversation size'] = percentageFormatter(d['Conversation size'])

                return d
            }).then(function (data) {

                data.sort((a, b) => b[index].localeCompare(a[index]))
                for (i = 0; i < data.length; i++) {
                    //create list of countries
                    countries.push(data[i][index])
                }

                //var dom = document.getElementById("container");
                var chart = echarts.init(d3.select("#chart").node());
                echarts.registerMap('EU', eu, {});
                //var app = {};

                option = {
                    legend: {},
                    tooltip: {
                        //trigger: 'axis',
                        //showContent: false
                    },
                    dataset: {
                        dimensions: index_all_dimensions,
                        source: data
                    },
                    visualMap: {
                        min: 0,
                        max: getMax(data, selected_category),
                        orient: 'horizontal',
                        left: 'center',
                        top: 'bottom',
                        calculable: true
                    },

                    yAxis: { type: 'category' },
                    xAxis: { gridIndex: 0 },
                    grid: { right: '75%', left: '120px' },
                    series: [
                        {
                            type: 'bar',
                            id: 'bar',
                            encode: {
                                y: index,
                                x: selected_category
                            }
                        },
                        {
                            type: 'pie',
                            id: 'pie',
                            radius: '30%',
                            center: ['50%', '25%'],
                            label: {
                                formatter: '{b}: {@' + selected_category + '} ({d}%)'
                            },
                            data: []
                        },
                        {
                            id: 'map',
                            type: 'map',
                            roam: false,
                            map: 'EU',
                            itemStyle: {
                                emphasis: { label: { show: true } }
                            },
                            data: getCountryValues(data, index, selected_category)
                        }
                    ]
                };

                chart.on('click', function (event) {
                    selected_country = event['name']
                    chart.setOption({
                        series: {
                            id: 'pie',
                            data: getKeyValues(data, index, selected_country, categories)
                        }
                    });
                });

                // chart.on('updateAxisPointer', function (event) {
                //     var xAxisInfo = event.axesInfo[0];
                //     if (xAxisInfo) {
                //         var dimension = xAxisInfo.value;
                //         selected_country = countries[dimension]
                //         chart.setOption({
                //             series: {
                //                 id: 'pie',
                //                 data: getKeyValues(data, index, selected_country, categories)
                //             }
                //         });
                //     }
                //     // chart.dispatchAction({
                //     //     type: 'highlight',
                //     //     name: 'Hungary'
                //     // })
                // });


                var button_width = 100;
                d3.select("body")
                    .selectAll("input")
                    .data(categories)
                    .enter().append("input")
                    .attr("type", "button")
                    .attr("class", "button")
                    .attr("value", function (d) { return d; })
                    .style('position', 'fixed')
                    .style('top', '0px')
                    .style('left', function (d, i) {
                        return i * (button_width + 5) + 'px'
                    })
                    .style('width', button_width + 'px')
                    .on('click', function (d) {
                        selected_category = d;
                        chart.setOption({
                            series: [
                                {
                                    id: 'bar',
                                    encode: {
                                        x: selected_category
                                    }
                                },
                                {
                                    id: 'map',
                                    data: getCountryValues(data, index, selected_category)
                                }
                            ],
                            visualMap: {
                                max: getMax(data, selected_category)
                            }
                        });
                    })


                if (option && typeof option === "object") {
                    chart.setOption(option, true);
                }

            })
        })
    </script>
</body>

</html>