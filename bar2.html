<!DOCTYPE html>
<html style="height: 100%">

<head>
    <meta charset="utf-8">
    <style>
        div {
            position: fixed;
            top: 0px;
        }
    </style>
</head>

<body style="height: 100%; margin: 0">
    <div id="bar" style="height: 100%; width: 800px; left:10px;"></div>
    <div id="pie" style="height: 50%; width: 400px; left:50%; border: solid 1px black;"></div>
    <script type="text/javascript" src="echarts.min.js"></script>
    <script src="d3-fetch.v1.min.js"></script>
    <script src="d3-dsv.v1.min.js"></script>
    <script src="d3-selection.v1.min.js"></script>
    <script type="text/javascript">

        function percentageFormatter(d) {
            return +d.replace('%', '')
        }

        d3.dsv(",", "data.csv", function (d) {
            //make numbers positve, change labels if needed
            d['Conversation size'] = percentageFormatter(d['Conversation size'])
            d['Demographics'] = percentageFormatter(d['Demographics'])
            d['Domestic politics'] = percentageFormatter(d['Domestic politics'])
            d['EU politics'] = percentageFormatter(d['EU politics'])
            d['Economy'] = percentageFormatter(d['Economy'])
            d['Humanitarianism'] = percentageFormatter(d['Humanitarianism'])
            d['Identity & Customs'] = percentageFormatter(d['Identity & Customs'])
            d['Securitization'] = percentageFormatter(d['Securitization'])
            d['Refugee percent'] = percentageFormatter(d['Refugee percent'])
            return d
        }).then(function (data) {

            console.log(data)
            var categories = ['Securitization', 'Humanitarianism', 'Economy', 'Demographics', 'Identity & Customs'];
            var selected_category = 'Securitization';
            var dimensions = ['Refugee percent', 'Conversation size'];
            var labels = ['EU politics', 'Domestic politics', 'Local note', 'Description'];
            var index = 'Country name';
            var all_dimensions = [index].concat(categories).concat(dimensions).concat(labels);
            //var dom = document.getElementById("container");
            var bar = echarts.init(d3.select("#bar").node());
            var pie = echarts.init(d3.select("#pie").node());
            //var app = {};
            bar_option = {
                dataset: {
                    dimensions: all_dimensions,
                    source: data
                },
                yAxis: {
                    type: 'category',
                    inverse: true,
                },
                xAxis: {
                    gridIndex: 0
                },
                grid: { left: '120px' },
                series: [
                    {
                        type: 'bar',
                        xAxisIndex: 1,
                        yAxisIndex: 1,
                        encode: {
                            y: index,
                            x: selected_category
                        }
                    },
                    {
                        type: 'bar',
                        encode: {
                            y: index,
                            x: selected_category
                        }
                    }
                ],
                tooltip: {
                    //formatter: "{b}: {c}"
                }
            };

            pie_option = {
                tooltip: {
                    trigger: 'item',
                    formatter: "{a} <br/>{b}: {c} ({d}%)"
                },
                // legend: {
                //     orient: 'vertical',
                //     x: 'left',
                //     data: ['直接访问', '邮件营销', '联盟广告', '视频广告', '搜索引擎']
                // },
                series: [
                    {
                        name: '访问来源',
                        type: 'pie',
                        radius: ['50%', '70%'],
                        avoidLabelOverlap: false,
                        label: {
                            normal: {
                                show: false,
                                position: 'center'
                            },
                            emphasis: {
                                show: true,
                                textStyle: {
                                    fontSize: '30',
                                    fontWeight: 'bold'
                                }
                            }
                        },
                        labelLine: {
                            normal: {
                                show: false
                            }
                        },
                        data: [
                            { value: 335, name: '直接访问' },
                            { value: 310, name: '邮件营销' },
                            { value: 234, name: '联盟广告' },
                            { value: 135, name: '视频广告' },
                            { value: 1548, name: '搜索引擎' }
                        ]
                    }
                ]
            };

            var button_width = 100;
            d3.select("body")
                .selectAll("input")
                .data(categories.concat())
                .enter().append("input")
                .attr("type", "button")
                .attr("class", "button")
                .attr("value", function (d) { return d; })
                .style('position', 'fixed')
                .style('top', '0px')
                .style('left', function (d, i) {
                    return i * (button_width + 5) + 'px'
                })
                .style('width', button_width + 'px')
                .on('click', function (d) {
                    bar_option.series[0].encode.x = d;
                    render(bar, bar_option)
                })

            function render(chart, option) {
                if (option && typeof option === "object") {
                    chart.setOption(option, true);
                }
            }

            render(bar, bar_option)
            render(pie, pie_option)

        })
    </script>
</body>

</html>