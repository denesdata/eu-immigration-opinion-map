<!DOCTYPE html>
<html style="height: 100%">

<head>
    <meta charset="utf-8">
    <style>
        div {
            position: fixed;
            top: 0px;
        }
    </style>
</head>

<body style="height: 100%; margin: 0">
    <div id="chart" style="height: 100%; width: 800px; left:10px;"></div>
    <script type="text/javascript" src="echarts.min.js"></script>
    <script src="d3-fetch.v1.min.js"></script>
    <script src="d3-dsv.v1.min.js"></script>
    <script src="d3-selection.v1.min.js"></script>
    <script type="text/javascript">

        function percentageFormatter(d) {
            return +d.replace('%', '')
        }

        function getKeyValues(data, index, key, valueArray) {
            var dummy = [];
            for (i = 0; i < data.length; i++) {
                if (data[i][index] == key) {
                    var keys = Object.keys(data[i]);
                    for (j = 0; j < keys.length; j++) {
                        if (valueArray.includes(keys[j])) {
                            dummy.push({
                                'name': keys[j],
                                'value': data[i][keys[j]]
                            })
                        }
                    }
                }
            }
            return dummy
        }

        var categories = ['Securitization', 'Humanitarianism', 'Economy', 'Demographics', 'Identity & Customs'];
        var selected_category = 'Securitization';
        var selected_country = 'Hungary';
        var dimensions = ['Refugee percent', 'Conversation size'];
        var labels = ['EU politics', 'Domestic politics', 'Local note', 'Description'];
        var index = 'Country name';
        var all_dimensions = categories.concat(dimensions).concat(labels);
        var index_all_dimensions = [index].concat(categories).concat(dimensions).concat(labels);
        var countries=[]

        d3.dsv(",", "data.csv", function (d) {
            //remvoe % sign, change labels if needed
            for (i=0;i<all_dimensions.length;i++){
                var dim=all_dimensions[i];
                d[dim]=percentageFormatter(d[dim])
            }

            //manual overwrites
            //d['Conversation size'] = percentageFormatter(d['Conversation size'])
            
            //create list of countries
            countries.push(d[index])
            
            return d
        }).then(function (data) {

            console.log(data)
            //var dom = document.getElementById("container");
            var chart = echarts.init(d3.select("#chart").node());
            //var app = {};

            option = {
                legend: {},
                tooltip: {
                    trigger: 'axis',
                    showContent: false
                },
                dataset: {
                    dimensions: index_all_dimensions,
                    source: data
                },
                xAxis: { type: 'category' },
                yAxis: { gridIndex: 0 },
                grid: { top: '55%' },
                series: [
                    {
                        type: 'bar',
                        encode: {
                            x: index,
                            y: selected_category
                        }
                    },
                    {
                        type: 'pie',
                        id: 'pie',
                        radius: '30%',
                        center: ['50%', '25%'],
                        label: {
                            formatter: '{b}: {@' + selected_category + '} ({d}%)'
                        },
                        data: []
                    }
                ]
            };

            chart.on('click', function (event) {
                console.log(event)
                var xAxisInfo = event.axesInfo[0];
                if (xAxisInfo) {
                    var dimension = xAxisInfo.value;
                    selected_country=countries[dimension]
                    chart.setOption({
                        series: {
                            id: 'pie',
                            data: getKeyValues(data, index, selected_country, categories)
                        }
                    });
                }
            });


            var button_width = 100;
            d3.select("body")
                .selectAll("input")
                .data(categories.concat())
                .enter().append("input")
                .attr("type", "button")
                .attr("class", "button")
                .attr("value", function (d) { return d; })
                .style('position', 'fixed')
                .style('top', '0px')
                .style('left', function (d, i) {
                    return i * (button_width + 5) + 'px'
                })
                .style('width', button_width + 'px')
                .on('click', function (d) {
                    option.series[0].encode.y = d;
                    render(chart, option)
                })

            function render(chart, option) {
                if (option && typeof option === "object") {
                    chart.setOption(option, true);
                }
            }

            render(chart, option)

        })
    </script>
</body>

</html>