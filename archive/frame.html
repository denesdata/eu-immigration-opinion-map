<!DOCTYPE html>
<html lang="en" class="no-js">

<head>
	<meta charset="UTF-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Natural Language Form</title>
	<meta name="description" content="Natural Language Form with custom text input and drop-down lists" />
	<meta name="keywords"
		content="Natural Language UI, sentence form, text input, contenteditable, html5, css3, jquery" />
	<meta name="author" content="Codrops" />
	<link rel="shortcut icon" href="favicon.ico">
	<link rel="stylesheet" type="text/css" href="default.css" />
	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.0/css/all.css"
		integrity="sha384-Mmxa0mLqhmOeaE8vgOSbKacftZcsNYDjQzuCOm6D02luYSzBG8vpaOykv9lFQ51Y" crossorigin="anonymous">
</head>

<body class="nl-blurred">
	<div id="chart" style="height: 700px; width: 1000px;"></div>
	<div id='logo' class='text'>
		<!-- <i class="fas fa-globe-europe"></i> -->
		<i class="fas fa-user-shield"></i>
	</div>
	<div id='title' class='text'>What do Europeans <u>actually</u> think about immigration?</div>
	<div id='cat' class='text'></div>
	<div id='dim' class='text'></div>
	<div id='desc1' class='text'></div>
	<div id='desc2' class='text'>
		This work was supported through the <b>ABCD foundation</b>. We would like to thank them for their generous support.
		We can also put their logos and links and a <i class="fas fa-question"></i> <b>guide/help</b> for those who want to read more.
	</div>
	<div id='social' class='text'>
		<i class="fab fa-facebook-f"></i>
		<i class="fab fa-twitter"></i>
		<i class="fas fa-download"></i>
	</div>
	<footer id='footer' class='text'>
		<i class="fas fa-at"></i>&nbsp;<a title='credit' alt='credit' href='https://www.bakamosocial.com/'
			target='_blank'>Bakamo.Social</a>
		&nbsp;&nbsp;<i class="fas fa-chart-pie"></i>&nbsp;<a title='viz' alt='viz' href='https://data.csaladen.es/'
			target='_blank'>DC2</a>
		&nbsp;&nbsp;<i class="fas fa-database"></i>&nbsp;<a title='data' alt='data' href='https://www.bakamosocial.com/'
			target='_blank'>Data.Source</a>
	</footer>
	<div id='form' class='text'>
		We observed their online behaviuor throughout 2015-2018 and then we came up with 5 topics describing the
		greatest concern areas for each
		country. The map shows what percentage of the population thinks
		immmigration is mostly tematized along
		<span id='category' class="dropdown">
			<!-- <option value="Securitization" selected>Securitization</option> -->
		</span>. The chart on the left displays their
		<span id='dimension' class="dropdown">
			<!-- <option value="1" selected>refugee percent</option> -->
		</span>. We show the topic breakdown and detailed info for
		<span id='country' class="dropdown">
			<!-- <option value="1" selected>Germany</option> -->
		</span>.
	</div>

	<script type="text/javascript" src="echarts.min.js"></script>
	<script src="d3-fetch.v1.min.js"></script>
	<script src="d3-dsv.v1.min.js"></script>
	<script src="d3-selection.v1.min.js"></script>
	<script type="text/javascript">

		function percentageFormatter(d) {
			return +d.replace('%', '')
		}

		function getKeyValues(data, index, key, valueArray) {
			var dummy = [];
			for (i = 0; i < data.length; i++) {
				if (data[i][index] == key) {
					var keys = Object.keys(data[i]);
					for (j = 0; j < keys.length; j++) {
						if (valueArray.includes(keys[j])) {
							dummy.push({
								'name': keys[j],
								'value': data[i][keys[j]],
								'visualMap': false
							})
						}
					}
				}
			}
			return dummy
		}

		function getCountryValues(data, index, key) {
			var dummy = [];
			for (i = 0; i < data.length; i++) {
				dummy.push({
					'name': data[i][index],
					'value': data[i][key]
				})
			}
			return dummy
		}

		function getMax(data, key) {
			return Math.max.apply(Math, data.map(function (o) { return o[key]; }))
		}

		var categories = ['Securitization', 'Humanitarianism', 'Economy', 'Demographics', 'Identity & Customs'];
		var category_icons = {
			'Securitization': 'shield-alt',
			'Humanitarianism': 'life-ring',
			'Economy': 'euro-sign',
			'Demographics': 'user-friends',
			'Identity & Customs': 'passport'
		};
		var selected_category = 'Securitization';
		var selected_country = 'Sweden';
		var default_country = 'Select country';
		var dimensions = ['Refugee percent', 'Conversation size'];
		var dimension_icons = {
			'Refugee percent': 'percentage',
			'Conversation size': 'comments'
		};
		var selected_dimension = 'Refugee percent'
		var labels = ['EU politics', 'Domestic politics', 'Local note', 'Description'];
		var index = 'Country name';
		var all_dimensions = categories.concat(dimensions);
		var labels_all_dimensions = all_dimensions.concat(labels);
		var index_all_dimensions = [index].concat(labels_all_dimensions);
		var countries = [];
		var font_color = '#2c7fb8';
		var font_small = 13;
		var footer_color = '#999';
		var color_eu_blue = '#003399';
		var color_eu_gold = '#FFCC00';
		var dark_color = '#222';
		var highlight_color = '#fc8d62';
		var colors = [
			//color_eu_gold,
			'#ffffcc',
			'#a1dab4',
			'#41b6c4',
			'#2c7fb8',
			//'#253494',
			color_eu_blue];
		var categorical = [
			'#41b6c4',
			'#225ea8',
			'#253494',
			'#2c7fb8',
			'#7fcdbb'
		]

		d3.json("eu.mini.high.geo.json").then(function (eu) {
			d3.dsv(",", "data.csv", function (d) {
				//remvoe % sign, change labels if needed
				for (i = 0; i < all_dimensions.length; i++) {
					var dim = all_dimensions[i];
					d[dim] = percentageFormatter(d[dim])
				}

				//manual overwrites
				//d['Conversation size'] = percentageFormatter(d['Conversation size'])

				return d
			}).then(function (rawdata) {
				rawdata.sort((a, b) => b[index].localeCompare(a[index]))
				var data_by_key = [];
				var data = [];
				for (i = 0; i < rawdata.length; i++) {
					//create list of countries
					data_by_key[rawdata[i][index]] = rawdata[i]
					if (parseInt(rawdata[i]['Show'])) {
						data.push(rawdata[i])
						countries.push(rawdata[i][index])
					}
				};

				countries.sort((a, b) => a.localeCompare(b))
				//console.log(rawdata)
				//console.log(data)
				//var dom = document.getElementById("container");
				var chart = echarts.init(d3.select("#chart").node());
				echarts.registerMap('EU', eu, {});
				//var app = {};

				option = {
					// legend: {
					// 	right: '10px',
					// 	top: '210px',
					// 	orient: 'vertical'
					// },
					toolbox: {
						show: false
					},
					tooltip: {
						trigger: 'item',
						showContent: true,
						formatter: function (d) {
							var values = getKeyValues(data, index, d.name, categories);
							var dims = getKeyValues(data, index, d.name, dimensions);
							var t = '<table><tr><th colspan=3>' + d.name + '</th><tr>';
							if (values.length) {
								t = t + '<tr><td colspan=3 style="border-bottom:solid 1px #eee;"></td><tr>'
								for (i = 0; i < values.length; i++) {
									t = t + '<tr><td><i class="fas fa-' +
										category_icons[values[i]['name']] +
										'"></i></td><td>' + values[i]['name'] +
										'</td><td>' + values[i]['value'] +
										' %</td></tr>'
								}
								t = t + '<tr><td colspan=3 style="border-bottom:solid 1px #eee;"></td><tr>'
								for (i = 0; i < dims.length; i++) {
									t = t + '<tr><td><i class="fas fa-' +
										dimension_icons[dims[i]['name']] +
										'"></i></td><td>' + dims[i]['name'] +
										'</td><td>' + dims[i]['value'] +
										' %</td></tr>'
								}
								t = t + '</table>'
								return t
							}
							else {
								return '<table><tr><td><i class="fas fa-' +
									category_icons[d.name] +
									'"></i></td><td>' + d.name +
									'</td><td>' + d.value +
									' %</td></tr></table>'
							}
						}
					},
					textStyle: { fontFamily: 'Lato' },
					color: categorical,
					dataset: {
						dimensions: index_all_dimensions,
						source: data
					},
					visualMap: {
						min: 0,
						max: getMax(data, selected_category),
						orient: 'horizontal',
						left: '320px',
						bottom: '20px',
						calculable: true,
						text: ['High Score', 'Low Score'],
						inRange: {
							color: colors
						},
						textStyle: {
							color: font_color,
							fontSize: font_small,
							//shadowColor: 'grey'
						}
					},

					yAxis: {
						type: 'category',
						axisLabel: {
							color: font_color,
							fontSize: font_small,
							//shadowColor: 'grey'
						}
					},
					xAxis: { gridIndex: 0, show: false },
					grid: { right: '750px', left: '120px', top: '190px', bottom: '28px' },
					series: [
						{
							id: 'map',
							type: 'map',
							roam: false,
							map: 'EU',
							showLegendSymbol: false,
							layoutCenter: ['480px', '400px'],
							layoutSize: '440px',
							itemStyle: {
								emphasis: {
									areaColor: highlight_color,
								}
							},
							label: {
								emphasis: {
									// color: font_color,
									color: dark_color,
									fontSize: font_small
									// show: false
								}
							},
							data: getCountryValues(data, index, selected_category)
						},
						{
							type: 'bar',
							id: 'bar',
							label: {
								show: true,
								position: 'right',
								fontWeight: 'bold'

							},
							itemStyle: {
								color: font_color,
								emphasis: {
									color: highlight_color,
									barBorderColor: font_color
								}
							},
							encode: {
								y: index,
								x: selected_dimension
							}
						},
						{
							type: 'pie',
							id: 'pie',
							center: ['820px', '430px'],
							radius: ['35px', '60px'],
							avoidLabelOverlap: true,
							itemStyle: {
								borderWidth: 1,
								borderColor: '#888'
							},
							label: {
								position: 'outside',
								formatter: [
									'{b|{b}}',
									'{a|{@' + selected_category + '} %}'
								].join('\n'),
								rich: {
									a: {
										fontSize: font_small + 3,
										color: font_color
									}
								},
								fontSize: font_small,
								color: font_color,
								fontWeight: 'bold',
								//textBorderColor: dark_color,
								//textBorderWidth: 1

							},
							labelLine: {
								show: true,
								length: 6,
								length2: 10
							},
							data: []
						}
					]
				};

				function update(new_country, new_category, new_dimension, is_country) {
					chart.dispatchAction({
						type: 'downplay',
						series: 'bar',
						name: selected_country
					})
					if ((new_country == selected_country) && (is_country))
						selected_country = default_country
					else selected_country = new_country;
					selected_category = new_category;
					selected_dimension = new_dimension;
					update_buttons();
					chart.setOption({
						series: [
							{
								id: 'bar',
								encode: {
									x: selected_dimension
								}
							},
							{
								id: 'map',
								data: getCountryValues(data, index, selected_category)
							},
							{
								id: 'pie',
								data: getKeyValues(data, index, selected_country, categories)
							}
						],
						visualMap: {
							max: getMax(data, selected_category)
						},
						title: [
							{
								text: (selected_country == default_country) ? '' : selected_country,
								left: '815px',
								top: '418px',
								textAlign: 'center',
								textVerticalAlign: 'middle',
								textStyle: {
									fontSize: 16,
									color: font_color
								}
							}
						]
					});
					chart.dispatchAction({
						type: 'highlight',
						series: 'bar',
						name: selected_country
					})
					d3.select('#cat')
						.html(function (d) {
							return '<i style="width:25px;" class="fas fa-' +
								category_icons[selected_category] +
								'"></i>' + selected_category
						})
					d3.select('#dim')
						.html(function (d) {
							return '<i style="width:25px;" class="fas fa-' +
								dimension_icons[selected_dimension] +
								'"></i>' + selected_dimension
						})
					d3.select('#desc1')
						.html(function (d) {
							var keyValues=getKeyValues(data, index, selected_country, categories)
							var maxKey=''
							var html=''
							if (keyValues.length) {
								maxKey=categories[Object.keys(keyValues).reduce((a, b) => keyValues[a]['value'] > keyValues[b]['value'] ? a : b)]
							html='In <b>'+selected_country+'</b> people most often associate immigration with ';
							html=html+'<b><i style="width:18px;" class="fas fa-' +
								category_icons[maxKey] +
								'"></i>'+maxKey+'</b>. The number of refugees in the country is <b>'+
								data_by_key[selected_country]['Refugee percent']+'</b> percent. '
							if (data_by_key[selected_country]['Local note'])
								html=html+'Other factors also play a role, such as <b>'+
								data_by_key[selected_country]['Local note']+'</b>.'
							}
							return (selected_country == default_country) ? '' :html
						})
				}

				chart.on('click', function (event) {
					if (event.componentSubType != 'pie') {
						update(event['name'], selected_category, selected_dimension, true)
					} else {
						update(selected_country, event['name'], selected_dimension, false)
					}
				});

				var country_select = d3.select("#country")
				country_select.selectAll("span")
					.data([selected_country])
					.enter()
					.append('span')
					.attr('class', 'dropbtn')
				country_select.append('div')
					.attr('class', 'dropdown-content')
					.selectAll('a')
					.data(countries)
					.enter()
					.append('a')
					.text(function (d) { return d })
					.on('click', function (d) {
						update(d, selected_category, selected_dimension, true)
					})
				var category_select = d3.select("#category")
				category_select.selectAll("span")
					.data([selected_category])
					.enter()
					.append('span')
					.attr('class', 'dropbtn')
				category_select.append('div')
					.attr('class', 'dropdown-content')
					.selectAll('a')
					.data(categories)
					.enter()
					.append('a')
					.html(function (d) {
						return '<i style="width:25px;" class="fas fa-' +
							category_icons[d] +
							'"></i>' + d
					})
					.on('click', function (d) {
						update(selected_country, d, selected_dimension, false)
					})
				var dimension_select = d3.select("#dimension")
				dimension_select.selectAll("span")
					.data([selected_dimension])
					.enter()
					.append('span')
					.attr('class', 'dropbtn')
				dimension_select.append('div')
					.attr('class', 'dropdown-content')
					.selectAll('a')
					.data(dimensions)
					.enter()
					.append('a')
					.html(function (d) {
						return '<i style="width:25px;" class="fas fa-' +
							dimension_icons[d] +
							'"></i>' + d
					})
					.on('click', function (d) {
						update(selected_country, selected_category, d, false)
					})

				d3.selectAll('.dropbtn')
					.style('background-color', font_color)

				d3.selectAll('.dropdown-content a')
					.style('color', font_color)

				d3.selectAll('.text')
					.style('color', font_color)
					.style('opacity', 1)

				//d3.selectAll('#chart').style('border', 'solid 1px ' + font_color)
				//d3.selectAll('#chart').style('opacity', 0.2)

				d3.select('#footer')
					.style('color', footer_color)
				d3.select('#desc2')
					.style('color', footer_color)

				d3.select('#footer').selectAll('a')
					.style('color', footer_color)
					.style('text-decoration', 'none')

				function update_buttons() {
					country_select
						.selectAll(".dropbtn")
						.data([selected_country])
						.text(function (d) { return d })
					dimension_select
						.selectAll(".dropbtn")
						.data([selected_dimension])
						.html(function (d) {
							return '<i style="width:25px;" class="fas fa-' +
								dimension_icons[d] +
								'"></i>' + d
						})
					category_select
						.selectAll(".dropbtn")
						.data([selected_category])
						.html(function (d) {
							return '<i style="width:25px;" class="fas fa-' +
								category_icons[d] +
								'"></i>' + d
						})
				}


				if (option && typeof option === "object") {
					chart.setOption(option, true);
				}

				update(selected_country, selected_category, selected_dimension, false);

			})
		})
	</script>
</body>

</html>